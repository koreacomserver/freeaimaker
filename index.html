<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>네비게이션 코어</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
/* 기존 스타일 유지 */
:root { --bg:#fff; --fg:#111827; --muted:#6b7280; --brand:#16a34a; --card:#fff; --border:#e5e7eb; }
[data-theme="dark"] { --bg:#0b1220; --fg:#e5e7eb; --muted:#9ca3af; --brand:#22c55e; --card:#111827; --border:#1f2937; }
* { box-sizing:border-box; }
html, body { height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial; }
#map { height: 100%; width: 100%; }
.topbar{ position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:1000; width:min(980px,96vw); }
.card{ background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
.row{ display:flex; flex-wrap: wrap; gap:8px; padding:10px; align-items:center; }
.input-group { flex: 1; display: flex; gap: 6px; min-width: 200px; }
.input-group input{ width:100%; border:1px solid var(--border); background:transparent; color:var(--fg); padding:10px 12px; border-radius:10px; outline:none; }
.btn{ border:1px solid var(--border); background:var(--brand); color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; white-space: nowrap; }
.btn.secondary{ background:transparent; color:var(--fg); }
.btn.secondary.active { background: var(--brand); color: #fff; }
.muted{ color:var(--muted); font-size:13px; margin-left: auto; }
.info{ position:absolute; bottom:12px; left:50%; transform:translateX(-50%); z-index:1000; }
.pill{ padding:8px 12px; border-radius:999px; }
.search-results{ position:absolute; top:50px; left:0; right:0; max-height:300px; overflow:auto; z-index:1001; background:var(--card); border:1px solid var(--border); border-radius:10px; }
.search-item{ padding:6px 12px; cursor:pointer; border-bottom:1px solid var(--border); }
.search-item:last-child{ border-bottom:none; }
.search-item:hover{ background:var(--brand); color:#fff; }
/* 하단바 */
#bottombar { position:absolute; bottom:0; left:0; right:0; height:40px; background:var(--card); border-top:1px solid var(--border); display:flex; justify-content:center; align-items:center; cursor:pointer; z-index:1000; }
#bottombar span { transition: transform 0.3s; display:inline-block; }
#bottombar.hidden { transform: translateY(100%); transition: transform 0.3s; }
</style>
</head>
<body>
<div class="topbar card">
  <div class="row">
    <div class="input-group">
      <input id="from" placeholder="현위치 찾는 중..." />
      <input id="to" placeholder="도착지(예: 강남역)" />
    </div>
    <button class="btn" id="go">길찾기</button>
    <button class="btn secondary" id="tts">음성</button>
    <button class="btn secondary" id="pan">자동이동 끄기</button>
    <button class="btn secondary" id="theme">다크</button>
    <span class="muted" id="status">준비</span>
  </div>
</div>
<div class="search-results card" id="results" style="display:none;"></div>
<div id="map"></div>
<div class="info card pill" id="eta" style="display:none;">ETA</div>
<div id="bottombar"><span>▲</span></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const $ = (id)=>document.getElementById(id);
const state = { routeLayer:null, markers:[], steps:[], currentStepIdx:0, watchId:null, userMarker:null, autoPan:true, isInitialLocationSet:false, pin:null, avoidToll:false, bottomHidden:false };

const map = L.map('map').setView([37.5665, 126.9780], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);

/* 기존 함수 유지 */
function km(m){ return (m/1000).toFixed(1);} function min(s){ return Math.round(s/60); }
function setStatus(msg){ $('status').textContent = msg; }
function addMarker(lat,lon,label){ const m=L.marker([lat,lon]).addTo(map).bindPopup(label||''); state.markers.push(m); return m; }
function clearMarkers(){ state.markers.forEach(m=>map.removeLayer(m)); state.markers=[]; }

/* 검색 결과 */
async function geocode(q, multiple=false){ const url=new URL('https://nominatim.openstreetmap.org/search'); url.searchParams.set('q', q); url.searchParams.set('format','jsonv2'); url.searchParams.set('limit', multiple?'5':'1'); url.searchParams.set('addressdetails','1'); url.searchParams.set('accept-language','ko'); const res=await fetch(url, { headers:{'User-Agent':'vanilla-nav-core'} }); const data=await res.json(); if(!data.length) throw new Error('검색 결과 없음: '+q); return data; }
async function reverseGeocode(lat, lon){ const url=new URL('https://nominatim.openstreetmap.org/reverse'); url.searchParams.set('lat', lat); url.searchParams.set('lon', lon); url.searchParams.set('format','jsonv2'); url.searchParams.set('accept-language','ko'); const res=await fetch(url,{headers:{'User-Agent':'vanilla-nav-core'}}); const data=await res.json(); if(data.error) throw new Error(data.error); return data.display_name; }
async function osrm(from, to){ let url=`https://router.project-osrm.org/route/v1/driving/${from.lon},${from.lat};${to.lon},${to.lat}?overview=full&geometries=geojson&steps=true`; if(state.avoidToll) url+='&annotations=avoid'; const res=await fetch(url); if(!res.ok) throw new Error('경로 요청 실패'); const j=await res.json(); if(!j.routes?.length) throw new Error('경로 없음'); return j.routes[0]; }
function speak(text){ try{ const u=new SpeechSynthesisUtterance(text); u.lang='ko-KR'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){ console.warn('TTS 미지원'); } }
function drawRoute(route){ if(state.routeLayer) map.removeLayer(state.routeLayer); const coords=route.geometry.coordinates.map(([x,y])=>[y,x]); state.routeLayer=L.polyline(coords,{ color:'#2563eb', weight:5, opacity:.9 }).addTo(map); map.fitBounds(state.routeLayer.getBounds(), { padding:[48,48] }); const steps=route.legs?.[0]?.steps||[]; state.steps=steps.map(s=>({ name:s.name,distance:s.distance,duration:s.duration,instruction:s.maneuver?.instruction||s.name||'이동',location:s.maneuver?.location?{lon:s.maneuver.location[0],lat:s.maneuver.location[1]}:null,preannounced:false })); state.currentStepIdx=0; $('eta').style.display='block'; $('eta').textContent=`예상 ${min(route.duration)}분 · ${km(route.distance)}km`; setStatus('경로 표시됨'); if(state.steps.length){ speak(`경로를 시작합니다. 총 ${min(route.duration)}분, ${km(route.distance)}킬로미터`); } }

async function showResults(query){ try{ const data=await geocode(query,true); const container=$('results'); container.innerHTML=''; container.style.display='block'; data.forEach(d=>{ const div=document.createElement('div'); div.className='search-item'; div.innerHTML=`<b>${d.display_name.split(',')[0]}</b><br><small>${d.display_name}</small>`; div.onclick=()=>{$('to').value=d.display_name; container.style.display='none';}; container.appendChild(div); }); }catch(e){ console.error(e); $('results').style.display='none'; } }
$('to').addEventListener('input', e=>{ const val=e.target.value.trim(); if(val.length>1) showResults(val); else $('results').style.display='none'; });

async function route(){ try{ setStatus('경로 계산 중...'); clearMarkers(); const fromQuery=$('from').value.trim(); const from=fromQuery?(await geocode(fromQuery))[0]:{lat:state.userMarker.getLatLng().lat, lon:state.userMarker.getLatLng().lng}; const toQuery=$('to').value.trim(); if(!toQuery) return alert('도착지를 입력하세요'); const to=(await geocode(toQuery))[0]; addMarker(from.lat, from.lon,'출발'); addMarker(to.lat, to.lon,'도착'); const r=await osrm(from,to); drawRoute(r); startWatch(); }catch(e){ console.error(e); alert('경로를 찾지 못했습니다. 입력을 확인하세요.'); setStatus('실패'); } }
function startWatch(){ if(!navigator.geolocation) return; if(state.watchId) navigator.geolocation.clearWatch(state.watchId); state.watchId=navigator.geolocation.watchPosition(onPos, ()=>{ setStatus('위치 확인 불가'); }, { enableHighAccuracy:true, maximumAge:2000, timeout:8000 }); }
function haversine(lat1,lon1,lat2,lon2){ const R=6371000; const toRad=(d)=>d*Math.PI/180; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1); return 2*R*Math.atan2(Math.sqrt(Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2), Math.sqrt(1-(Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2))); }
async function onPos(pos){ const { latitude, longitude }=pos.coords; if(!state.isInitialLocationSet){ state.isInitialLocationSet=true; try{ $('from').value=await reverseGeocode(latitude,longitude);}catch(e){ console.error(e); $('from').placeholder='출발지를 입력하세요'; } }
if(!state.userMarker){ state.userMarker=L.circleMarker([latitude,longitude],{radius:8,color:'#1d4ed8',fillColor:'#3b82f6',fillOpacity:0.9,weight:2}).addTo(map).bindPopup('현위치');}else state.userMarker.setLatLng([latitude,longitude]);
if(state.autoPan) map.setView([latitude,longitude],Math.max(map.getZoom(),16),{animate:true,duration:0.5});
if(!state.steps.length || state.currentStepIdx>=state.steps.length) return; const step=state.steps[state.currentStepIdx]; const target=step?.location; if(!target) return; const d=haversine(latitude,longitude,target.lat,target.lon);
if(d<150 && !step.preannounced){ const rounded=Math.round(d/10)*10; if(rounded>35){ speak(`잠시 후 ${rounded}미터 앞에서 ${step.instruction}.`); step.preannounced=true; }}
if(d<35){ const next=state.steps[state.currentStepIdx+1]; speak(step?.instruction||'다음 안내'); state.currentStepIdx=Math.min(state.currentStepIdx+1,state.steps.length-1); if(next) setStatus(`다음: ${next.instruction}`); else{ setStatus('목적지 근처'); speak('목적지에 도착했습니다.'); state.steps=[];}}}
$('go').onclick=route;
$('tts').onclick=()=>speak('안내 음성 테스트입니다.');
$('theme').onclick=()=>{ const root=document.documentElement; const isDark=root.getAttribute('data-theme')==='dark'; root.setAttribute('data-theme',isDark?'light':'dark'); $('theme').textContent=isDark?'다크':'라이트'; };
$('pan').onclick=()=>{ state.autoPan=!state.autoPan; $('pan').textContent=state.autoPan?'자동이동 끄기':'자동이동 켜기'; $('pan').classList.toggle('active',state.autoPan); if(state.autoPan&&state.userMarker) map.setView(state.userMarker.getLatLng(),Math.max(map.getZoom(),16),{animate:true}); };
$('pan').classList.toggle('active',state.autoPan);
state.pin=L.marker(map.getCenter(), { draggable:true }).addTo(map);
$('pinSet').onclick=()=>{ const c=state.pin.getLatLng(); $('to').value=`핀: ${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}`; map.setView(c,16); };
$('to').value='강남역';
startWatch();

// 하단바 토글
const bottombar = $('bottombar');
bottombar.onclick=()=>{
  state.bottomHidden=!state.bottomHidden;
  bottombar.classList.toggle('hidden', state.bottomHidden);
  bottombar.querySelector('span').textContent = state.bottomHidden ? '▼' : '▲';
};
</script>
</body>
</html>
